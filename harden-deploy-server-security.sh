#!/usr/bin/env bash
#
# setup-security.sh
# One-shot script to fix UFW + SSH + Fail2Ban issues as per common security panels
# Targeted at Ubuntu 22.04 / 24.04 / Debian 11/12
#
# WARNING: Disables SSH password auth → ENSURE YOU HAVE KEY-BASED ACCESS WORKING!
#

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Starting security hardening (UFW + SSH + Fail2Ban)${NC}"
echo "Date: $(date)"
echo ""

# ────────────────────────────────────────────────
# 1. Update system & install prerequisites
# ────────────────────────────────────────────────
echo -e "${GREEN}→ Updating package lists and installing tools...${NC}"
apt-get update -qq
DEBIAN_FRONTEND=noninteractive apt-get install -y -qq \
    ufw \
    fail2ban \
    openssh-server

# ────────────────────────────────────────────────
# 2. Configure UFW
# ────────────────────────────────────────────────
echo -e "${GREEN}→ Configuring UFW...${NC}"

# Allow SSH (critical – do this BEFORE enabling!)
ufw allow OpenSSH     # or: ufw allow 22/tcp
# If you use non-standard SSH port, change to: ufw allow 2222/tcp

ufw --force reset     # optional: clean previous rules (careful!)
ufw default deny incoming
ufw default allow outgoing
ufw default deny routed   # optional, but good practice

# Enable UFW (will apply immediately)
echo "y" | ufw enable

ufw status verbose

echo -e "${GREEN}UFW enabled with default deny incoming.${NC}"

# ────────────────────────────────────────────────
# 3. Harden SSH configuration
# ────────────────────────────────────────────────
echo -e "${GREEN}→ Hardening SSH configuration...${NC}"

SSHD_CONFIG="/etc/ssh/sshd_config"
SSHD_D_DIR="/etc/ssh/sshd_config.d"

# Modern Ubuntu includes /etc/ssh/sshd_config.d/50-cloud-init.conf or similar
# We override password auth there if it exists

if [[ -d "$SSHD_D_DIR" ]]; then
    # Create/override in drop-in directory (higher priority)
    echo -e "${YELLOW}Using drop-in config in ${SSHD_D_DIR}${NC}"
    cat > "${SSHD_D_DIR}/99-security.conf" << 'EOF'
# Security hardening - generated by setup script
PasswordAuthentication no
KbdInteractiveAuthentication no
PermitRootLogin prohibit-password
EOF
else
    # Classic method
    sed -i 's/#\?PasswordAuthentication.*/PasswordAuthentication no/' "$SSHD_CONFIG"
    sed -i 's/#\?KbdInteractiveAuthentication.*/KbdInteractiveAuthentication no/' "$SSHD_CONFIG"
    sed -i 's/#\?PermitRootLogin.*/PermitRootLogin prohibit-password/' "$SSHD_CONFIG"
fi

# Make sure pubkey is explicitly allowed (usually already is)
sed -i 's/#\?PubkeyAuthentication.*/PubkeyAuthentication yes/' "$SSHD_CONFIG"

# Optional: reduce login grace time, limit auth tries
{
    echo ""
    echo "# Added by security script"
    echo "LoginGraceTime 30"
    echo "MaxAuthTries 4"
} >> "$SSHD_CONFIG"

# Restart SSH (very dangerous step if keys don't work!)
systemctl restart ssh

echo -e "${GREEN}SSH config updated. Password auth disabled.${NC}"
echo -e "${YELLOW}If you lose connection → use console/rescue mode to revert!${NC}"

# ────────────────────────────────────────────────
# 4. Install & configure Fail2Ban (aggressive mode for SSH)
# ────────────────────────────────────────────────
echo -e "${GREEN}→ Configuring Fail2Ban (aggressive SSH protection)${NC}"

# Create jail.local (overrides defaults)
cat > /etc/fail2ban/jail.local << 'EOF'
[DEFAULT]
bantime  = 4h
findtime = 10m
maxretry = 5
backend  = systemd   # better on modern Ubuntu

[sshd]
enabled  = true
port     = ssh
filter   = sshd
logpath  = %(sshd_log)s
mode     = aggressive     # ← what the panel recommends
maxretry = 3
findtime = 10m
bantime  = 24h
EOF

# Restart & enable Fail2Ban
systemctl restart fail2ban
systemctl enable fail2ban

# Quick status check
fail2ban-client status sshd || true

echo -e "${GREEN}Fail2Ban installed, enabled, SSH jail set to aggressive mode.${NC}"

# ────────────────────────────────────────────────
# Summary
# ────────────────────────────────────────────────
echo ""
echo -e "${GREEN}┌─────────────────────────────────────────────────────┐${NC}"
echo -e "${GREEN}│              Security setup completed               │${NC}"
echo -e "${GREEN}└─────────────────────────────────────────────────────┘${NC}"
echo ""
echo "What was done:"
echo "  • UFW: enabled + default deny incoming + SSH allowed"
echo "  • SSH: password auth & PAM disabled, key-only"
echo "  • Fail2Ban: installed + SSH jail enabled + aggressive mode"
echo ""
echo -e "${YELLOW}Next steps:${NC}"
echo " 1. Test SSH key login from another machine NOW"
echo " 2. Run:   ufw status verbose"
echo " 3. Run:   fail2ban-client status sshd"
echo " 4. Run:   sshd -T | grep -i password"
echo ""
echo -e "${RED}If anything breaks → boot into rescue mode / console and revert changes.${NC}"
echo ""

exit 0
